<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ES for Eclipse Vert.x</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="shortcut icon" type="image/png" href="/es4x/favicon.png">
    <link rel="stylesheet" type="text/css" href="/es4x/player/asciinema-player.css">
    <script src="/es4x/player/asciinema-player.js"></script>
    <meta name="description" content="A Modern JavaScript runtime for Eclipse Vert.x">
    <link rel="preload" href="/es4x/assets/css/0.styles.57be2129.css" as="style"><link rel="preload" href="/es4x/assets/js/app.837a6700.js" as="script"><link rel="preload" href="/es4x/assets/js/2.96613d0f.js" as="script"><link rel="preload" href="/es4x/assets/js/64.a9a5d5d7.js" as="script"><link rel="prefetch" href="/es4x/assets/js/10.25f493b2.js"><link rel="prefetch" href="/es4x/assets/js/100.cfb483ce.js"><link rel="prefetch" href="/es4x/assets/js/101.41f0f345.js"><link rel="prefetch" href="/es4x/assets/js/102.11159607.js"><link rel="prefetch" href="/es4x/assets/js/103.26a38f31.js"><link rel="prefetch" href="/es4x/assets/js/104.5d636807.js"><link rel="prefetch" href="/es4x/assets/js/105.ef333a30.js"><link rel="prefetch" href="/es4x/assets/js/106.9a8e6256.js"><link rel="prefetch" href="/es4x/assets/js/107.29eb69ad.js"><link rel="prefetch" href="/es4x/assets/js/108.98fcfd9a.js"><link rel="prefetch" href="/es4x/assets/js/109.d6080ff5.js"><link rel="prefetch" href="/es4x/assets/js/11.6250afa8.js"><link rel="prefetch" href="/es4x/assets/js/110.3dd0cba3.js"><link rel="prefetch" href="/es4x/assets/js/111.4090be57.js"><link rel="prefetch" href="/es4x/assets/js/112.9c319411.js"><link rel="prefetch" href="/es4x/assets/js/113.84433759.js"><link rel="prefetch" href="/es4x/assets/js/114.68cb87cc.js"><link rel="prefetch" href="/es4x/assets/js/115.65241419.js"><link rel="prefetch" href="/es4x/assets/js/116.72987dea.js"><link rel="prefetch" href="/es4x/assets/js/117.03106a2c.js"><link rel="prefetch" href="/es4x/assets/js/118.0ad98106.js"><link rel="prefetch" href="/es4x/assets/js/119.cb303101.js"><link rel="prefetch" href="/es4x/assets/js/12.31be7a28.js"><link rel="prefetch" href="/es4x/assets/js/120.e2ffbd45.js"><link rel="prefetch" href="/es4x/assets/js/121.197dd995.js"><link rel="prefetch" href="/es4x/assets/js/122.8b966b22.js"><link rel="prefetch" href="/es4x/assets/js/123.4586e425.js"><link rel="prefetch" href="/es4x/assets/js/124.8377618c.js"><link rel="prefetch" href="/es4x/assets/js/125.da368490.js"><link rel="prefetch" href="/es4x/assets/js/126.e0bbd98d.js"><link rel="prefetch" href="/es4x/assets/js/127.fc93d280.js"><link rel="prefetch" href="/es4x/assets/js/128.98e5a4cc.js"><link rel="prefetch" href="/es4x/assets/js/129.c7621804.js"><link rel="prefetch" href="/es4x/assets/js/13.3ba77560.js"><link rel="prefetch" href="/es4x/assets/js/130.5cd4d89d.js"><link rel="prefetch" href="/es4x/assets/js/131.ae0d85c1.js"><link rel="prefetch" href="/es4x/assets/js/132.e08c4610.js"><link rel="prefetch" href="/es4x/assets/js/133.c0606af1.js"><link rel="prefetch" href="/es4x/assets/js/134.6426c832.js"><link rel="prefetch" href="/es4x/assets/js/135.cfc1f0ec.js"><link rel="prefetch" href="/es4x/assets/js/136.a8b15a1b.js"><link rel="prefetch" href="/es4x/assets/js/137.35e8cd32.js"><link rel="prefetch" href="/es4x/assets/js/138.312a152f.js"><link rel="prefetch" href="/es4x/assets/js/139.e437bff1.js"><link rel="prefetch" href="/es4x/assets/js/14.72f2b0c1.js"><link rel="prefetch" href="/es4x/assets/js/140.8d09b641.js"><link rel="prefetch" href="/es4x/assets/js/141.52848e3f.js"><link rel="prefetch" href="/es4x/assets/js/142.39cf7674.js"><link rel="prefetch" href="/es4x/assets/js/143.7d902150.js"><link rel="prefetch" href="/es4x/assets/js/144.3e74a206.js"><link rel="prefetch" href="/es4x/assets/js/145.6a2886f8.js"><link rel="prefetch" href="/es4x/assets/js/146.244849e4.js"><link rel="prefetch" href="/es4x/assets/js/147.7f0c9791.js"><link rel="prefetch" href="/es4x/assets/js/148.ab94dede.js"><link rel="prefetch" href="/es4x/assets/js/149.a49458da.js"><link rel="prefetch" href="/es4x/assets/js/15.bd087613.js"><link rel="prefetch" href="/es4x/assets/js/150.eabb62e5.js"><link rel="prefetch" href="/es4x/assets/js/151.a6f046ed.js"><link rel="prefetch" href="/es4x/assets/js/152.78e21db3.js"><link rel="prefetch" href="/es4x/assets/js/153.eef01fd9.js"><link rel="prefetch" href="/es4x/assets/js/154.68000f3a.js"><link rel="prefetch" href="/es4x/assets/js/155.51583889.js"><link rel="prefetch" href="/es4x/assets/js/156.b598ecad.js"><link rel="prefetch" href="/es4x/assets/js/157.37bfe59b.js"><link rel="prefetch" href="/es4x/assets/js/158.14f16fe6.js"><link rel="prefetch" href="/es4x/assets/js/159.5019694d.js"><link rel="prefetch" href="/es4x/assets/js/16.a392a655.js"><link rel="prefetch" href="/es4x/assets/js/160.dfe7924a.js"><link rel="prefetch" href="/es4x/assets/js/161.acc5cf27.js"><link rel="prefetch" href="/es4x/assets/js/162.5c855be0.js"><link rel="prefetch" href="/es4x/assets/js/163.841834be.js"><link rel="prefetch" href="/es4x/assets/js/164.368aca3b.js"><link rel="prefetch" href="/es4x/assets/js/165.0c08e67b.js"><link rel="prefetch" href="/es4x/assets/js/166.361b2ec9.js"><link rel="prefetch" href="/es4x/assets/js/167.a45d61db.js"><link rel="prefetch" href="/es4x/assets/js/168.2f440f57.js"><link rel="prefetch" href="/es4x/assets/js/169.40f71d05.js"><link rel="prefetch" href="/es4x/assets/js/17.f58ddc3f.js"><link rel="prefetch" href="/es4x/assets/js/170.bfd53069.js"><link rel="prefetch" href="/es4x/assets/js/171.73de0958.js"><link rel="prefetch" href="/es4x/assets/js/172.c0640f4c.js"><link rel="prefetch" href="/es4x/assets/js/18.e2866c20.js"><link rel="prefetch" href="/es4x/assets/js/19.5895c9c4.js"><link rel="prefetch" href="/es4x/assets/js/20.bbfce85e.js"><link rel="prefetch" href="/es4x/assets/js/21.bfb22c95.js"><link rel="prefetch" href="/es4x/assets/js/22.bfe5d665.js"><link rel="prefetch" href="/es4x/assets/js/23.7db73d21.js"><link rel="prefetch" href="/es4x/assets/js/24.1e68764d.js"><link rel="prefetch" href="/es4x/assets/js/25.80677ca8.js"><link rel="prefetch" href="/es4x/assets/js/26.05452c59.js"><link rel="prefetch" href="/es4x/assets/js/27.9cb32590.js"><link rel="prefetch" href="/es4x/assets/js/28.08149c08.js"><link rel="prefetch" href="/es4x/assets/js/29.147441c7.js"><link rel="prefetch" href="/es4x/assets/js/3.4d2250de.js"><link rel="prefetch" href="/es4x/assets/js/30.5f95f2c8.js"><link rel="prefetch" href="/es4x/assets/js/31.7000a792.js"><link rel="prefetch" href="/es4x/assets/js/32.a454f02e.js"><link rel="prefetch" href="/es4x/assets/js/33.9072e3dc.js"><link rel="prefetch" href="/es4x/assets/js/34.2cd817f7.js"><link rel="prefetch" href="/es4x/assets/js/35.1499c4b4.js"><link rel="prefetch" href="/es4x/assets/js/36.53b6ddf9.js"><link rel="prefetch" href="/es4x/assets/js/37.1b440312.js"><link rel="prefetch" href="/es4x/assets/js/38.1caa3e15.js"><link rel="prefetch" href="/es4x/assets/js/39.ab25bad3.js"><link rel="prefetch" href="/es4x/assets/js/4.2410671b.js"><link rel="prefetch" href="/es4x/assets/js/40.13850330.js"><link rel="prefetch" href="/es4x/assets/js/41.1f30e160.js"><link rel="prefetch" href="/es4x/assets/js/42.f65b46db.js"><link rel="prefetch" href="/es4x/assets/js/43.86bd3898.js"><link rel="prefetch" href="/es4x/assets/js/44.25aede52.js"><link rel="prefetch" href="/es4x/assets/js/45.cee33b90.js"><link rel="prefetch" href="/es4x/assets/js/46.08c82be4.js"><link rel="prefetch" href="/es4x/assets/js/47.9263c242.js"><link rel="prefetch" href="/es4x/assets/js/48.4ef5e818.js"><link rel="prefetch" href="/es4x/assets/js/49.51ca886c.js"><link rel="prefetch" href="/es4x/assets/js/5.0b93e503.js"><link rel="prefetch" href="/es4x/assets/js/50.54a8010f.js"><link rel="prefetch" href="/es4x/assets/js/51.26142f55.js"><link rel="prefetch" href="/es4x/assets/js/52.b132a309.js"><link rel="prefetch" href="/es4x/assets/js/53.edc43f5a.js"><link rel="prefetch" href="/es4x/assets/js/54.6794cce1.js"><link rel="prefetch" href="/es4x/assets/js/55.dfdebce6.js"><link rel="prefetch" href="/es4x/assets/js/56.2b9f4603.js"><link rel="prefetch" href="/es4x/assets/js/57.c707ed5a.js"><link rel="prefetch" href="/es4x/assets/js/58.925a6f1c.js"><link rel="prefetch" href="/es4x/assets/js/59.de86b06d.js"><link rel="prefetch" href="/es4x/assets/js/6.bee7d20c.js"><link rel="prefetch" href="/es4x/assets/js/60.e74847c7.js"><link rel="prefetch" href="/es4x/assets/js/61.f45f1d70.js"><link rel="prefetch" href="/es4x/assets/js/62.c7245534.js"><link rel="prefetch" href="/es4x/assets/js/63.91dfc6d8.js"><link rel="prefetch" href="/es4x/assets/js/65.82e7c7b1.js"><link rel="prefetch" href="/es4x/assets/js/66.9b26aed8.js"><link rel="prefetch" href="/es4x/assets/js/67.b882907b.js"><link rel="prefetch" href="/es4x/assets/js/68.6a6dc2a2.js"><link rel="prefetch" href="/es4x/assets/js/69.8e1e834e.js"><link rel="prefetch" href="/es4x/assets/js/7.408ffc95.js"><link rel="prefetch" href="/es4x/assets/js/70.f213078f.js"><link rel="prefetch" href="/es4x/assets/js/71.228413c9.js"><link rel="prefetch" href="/es4x/assets/js/72.d6ff0902.js"><link rel="prefetch" href="/es4x/assets/js/73.dbc371ba.js"><link rel="prefetch" href="/es4x/assets/js/74.13ff27d1.js"><link rel="prefetch" href="/es4x/assets/js/75.db024b7e.js"><link rel="prefetch" href="/es4x/assets/js/76.ef6180eb.js"><link rel="prefetch" href="/es4x/assets/js/77.7c3517c1.js"><link rel="prefetch" href="/es4x/assets/js/78.10e54671.js"><link rel="prefetch" href="/es4x/assets/js/79.b254f9ec.js"><link rel="prefetch" href="/es4x/assets/js/8.3d81d937.js"><link rel="prefetch" href="/es4x/assets/js/80.80c9d719.js"><link rel="prefetch" href="/es4x/assets/js/81.7be9486c.js"><link rel="prefetch" href="/es4x/assets/js/82.554dda8f.js"><link rel="prefetch" href="/es4x/assets/js/83.9d052d44.js"><link rel="prefetch" href="/es4x/assets/js/84.60798b2c.js"><link rel="prefetch" href="/es4x/assets/js/85.e4ce5e87.js"><link rel="prefetch" href="/es4x/assets/js/86.179d24c1.js"><link rel="prefetch" href="/es4x/assets/js/87.6d60cd83.js"><link rel="prefetch" href="/es4x/assets/js/88.6bfd1577.js"><link rel="prefetch" href="/es4x/assets/js/89.ddac2119.js"><link rel="prefetch" href="/es4x/assets/js/9.a0345499.js"><link rel="prefetch" href="/es4x/assets/js/90.4a4fd3dc.js"><link rel="prefetch" href="/es4x/assets/js/91.065cc9a5.js"><link rel="prefetch" href="/es4x/assets/js/92.80435a8d.js"><link rel="prefetch" href="/es4x/assets/js/93.b7af2039.js"><link rel="prefetch" href="/es4x/assets/js/94.b096f725.js"><link rel="prefetch" href="/es4x/assets/js/95.af24f6b1.js"><link rel="prefetch" href="/es4x/assets/js/96.38f15cba.js"><link rel="prefetch" href="/es4x/assets/js/97.c53fc06f.js"><link rel="prefetch" href="/es4x/assets/js/98.3426a32c.js"><link rel="prefetch" href="/es4x/assets/js/99.a568bb05.js">
    <link rel="stylesheet" href="/es4x/assets/css/0.styles.57be2129.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/es4x/" class="home-link router-link-active"><!----> <span class="site-name">ES for Eclipse Vert.x</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/es4x/get-started/" class="nav-link">
  Get started
</a></div><div class="nav-item"><a href="/es4x/advanced/" class="nav-link">
  Advanced
</a></div><div class="nav-item"><a href="/es4x/manual/" class="nav-link router-link-active">
  Manual
</a></div><div class="nav-item"><a href="/es4x/api/" class="nav-link">
  APIs
</a></div><div class="nav-item"><a href="https://github.com/reactiverse/es4x/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Changelog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/es4x/manual/@vertx/consul-client/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/es4x/zh/" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/es4x/pt/" class="nav-link">
  Português
</a></li></ul></div></div> <a href="https://github.com/reactiverse/es4x" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/es4x/get-started/" class="nav-link">
  Get started
</a></div><div class="nav-item"><a href="/es4x/advanced/" class="nav-link">
  Advanced
</a></div><div class="nav-item"><a href="/es4x/manual/" class="nav-link router-link-active">
  Manual
</a></div><div class="nav-item"><a href="/es4x/api/" class="nav-link">
  APIs
</a></div><div class="nav-item"><a href="https://github.com/reactiverse/es4x/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Changelog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/es4x/manual/@vertx/consul-client/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/es4x/zh/" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/es4x/pt/" class="nav-link">
  Português
</a></li></ul></div></div> <a href="https://github.com/reactiverse/es4x" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Manuals</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/es4x/manual/" aria-current="page" class="sidebar-link">API Reference Manuals</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="https://www.consul.io" target="_blank" rel="noopener noreferrer">Consul<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a tool for discovering and
configuring services in your infrastructure. A Vert.x client allowing
applications to interact with a Consul system via blocking and
non-blocking HTTP API.</p> <h1 id="using-vert-x-consul-client"><a href="#using-vert-x-consul-client" class="header-anchor">#</a> Using Vert.x Consul Client</h1> <p>To use this project, add the following dependency to the <em>dependencies</em>
section of your build descriptor:</p> <ul><li>Maven (in your <code>pom.xml</code>):</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.vertx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>vertx-consul-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${maven.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>Gradle (in your <code>build.gradle</code> file):</li></ul> <div class="language-groovy extra-class"><pre class="language-groovy"><code>compile <span class="token string">'io.vertx:vertx-consul-client:${maven.version}'</span>
</code></pre></div><h1 id="creating-a-client"><a href="#creating-a-client" class="header-anchor">#</a> Creating a client</h1> <p>Just use factory method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ConsulClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@vertx/consul&quot;</span>

<span class="token keyword">let</span> client <span class="token operator">=</span> ConsulClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>vertx<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Also the client can be configured with an options.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ConsulClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@vertx/consul&quot;</span>

<span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsulClientOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;consul.example.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> client <span class="token operator">=</span> ConsulClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>vertx<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The following configuration is supported by the consul client:</p> <ul><li><p><code>host</code><br>
Consul host. Defaults to <code>localhost</code></p></li> <li><p><code>port</code><br>
Consul HTTP API port. Defaults to <code>8500</code></p></li> <li><p><code>timeout</code><br>
Sets the amount of time (in milliseconds) after which if the request
does not return any data within the timeout period an failure will
be passed to the handler and the request will be closed.</p></li> <li><p><code>aclToken</code><br>
The ACL token. When provided, the client will use this token when
making requests to the Consul by providing the &quot;?token&quot; query
parameter. When not provided, the empty token, which maps to the
'anonymous' ACL policy, is used.</p></li> <li><p><code>dc</code><br>
The datacenter name. When provided, the client will use it when
making requests to the Consul by providing the &quot;?dc&quot; query
parameter. When not provided, the datacenter of the consul agent is
queried.</p></li></ul> <p>ConsulClient options extends WebClientOptions from <code>vertx-web-client</code>
module, therefore a lot of settings are available. Please see the
documentation.</p> <h1 id="using-the-api"><a href="#using-the-api" class="header-anchor">#</a> Using the API</h1> <p>The client API is represented by <code>ConsulClient</code>. The API is very similar
to Consul’s HTTP API that described in <a href="https://www.consul.io/docs/agent/http.html" target="_blank" rel="noopener noreferrer">Consul API
docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="blocking-queries"><a href="#blocking-queries" class="header-anchor">#</a> Blocking queries</h2> <p>Certain endpoints support a feature called a &quot;blocking query&quot;. A
blocking query is used to wait for a potential change using long
polling. Any endpoint that supports blocking also provide a unique
identifier (index) representing the current state of the requested
resource. The following configuration is used to perform blocking
queries:</p> <ul><li><p><code>index</code><br>
value indicating that the client wishes to wait for any changes
subsequent to that index.</p></li> <li><p><code>wait</code><br>
parameter specifying a maximum duration for the blocking request.
This is limited to 10 minutes.</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockingQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setWait</span><span class="token punctuation">(</span><span class="token string">&quot;1m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>A critical note is that the return of a blocking request is <strong>no
guarantee</strong> of a change. It is possible that the timeout was reached or
that there was an idempotent write that does not affect the result of
the query.</p> <h1 id="key-value-store"><a href="#key-value-store" class="header-anchor">#</a> Key/Value Store</h1> <p>The KV endpoints are used to access Consul’s simple key/value store,
useful for storing service configuration or other metadata. The
following endpoints are supported:</p> <ul><li><p>To manage updates of individual keys, deletes of individual keys or
key prefixes, and fetches of individual keys or key prefixes</p></li> <li><p>To manage updates or fetches of multiple keys inside a single,
atomic transaction</p></li></ul> <h2 id="get-key-value-pair-from-store"><a href="#get-key-value-pair-from-store" class="header-anchor">#</a> Get key-value pair from store</h2> <p>Consul client can return the value for certain key</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;retrieved value: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;modify index: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>modifyIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>…​or it can return all key-value pairs with the given prefix</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token string">&quot;prefix&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;modify index: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">kv</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;retrieved value: &quot;</span> <span class="token operator">+</span> kv<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The returned key-value object contains these fields (see
<a href="https://www.consul.io/docs/agent/http/kv.html#single" target="_blank" rel="noopener noreferrer">documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>):</p> <ul><li><p><code>createIndex</code><br>
the internal index value that represents when the entry was created.</p></li> <li><p><code>modifyIndex</code><br>
the last index that modified this key</p></li> <li><p><code>lockIndex</code><br>
the number of times this key has successfully been acquired in a
lock</p></li> <li><p><code>key</code><br>
the key</p></li> <li><p><code>flags</code><br>
the flags attached to this entry. Clients can choose to use this
however makes sense for their application</p></li> <li><p><code>value</code><br>
the value</p></li> <li><p><code>session</code><br>
the session that owns the lock</p></li></ul> <p>The modify index can be used for blocking queries:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockingQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>modifyIndex<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setWait</span><span class="token punctuation">(</span><span class="token string">&quot;1m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

consulClient<span class="token punctuation">.</span><span class="token function">getValueWithOptions</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;retrieved value: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;new modify index: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>modifyIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="put-key-value-pair-to-store"><a href="#put-key-value-pair-to-store" class="header-anchor">#</a> Put key-value pair to store</h2> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">putValue</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> opResult <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;success&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;result of the operation: &quot;</span> <span class="token operator">+</span> opResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Put request with options also accepted</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyValueOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setCasIndex</span><span class="token punctuation">(</span>modifyIndex<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setAcquireSession</span><span class="token punctuation">(</span><span class="token string">&quot;acquireSessionID&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setReleaseSession</span><span class="token punctuation">(</span><span class="token string">&quot;releaseSessionID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

consulClient<span class="token punctuation">.</span><span class="token function">putValueWithOptions</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> opResult <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;success&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;result of the operation: &quot;</span> <span class="token operator">+</span> opResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The list of the query options that can be used with a <code>PUT</code> request:</p> <ul><li><p><code>flags</code><br>
This can be used to specify an unsigned value between <code>0</code> and
<code>264-1</code>. Clients can choose to use this however makes sense for
their application.</p></li> <li><p><code>casIndex</code><br>
This flag is used to turn the PUT into a Check-And-Set operation.
This is very useful as a building block for more complex
synchronization primitives. If the index is <code>0</code>, Consul will only
put the key if it does not already exist. If the index is non-zero,
the key is only set if the index matches the ModifyIndex of that
key.</p></li> <li><p><code>acquireSession</code><br>
This flag is used to turn the PUT into a lock acquisition operation.
This is useful as it allows leader election to be built on top of
Consul. If the lock is not held and the session is valid, this
increments the LockIndex and sets the Session value of the key in
addition to updating the key contents. A key does not need to exist
to be acquired. If the lock is already held by the given session,
then the LockIndex is not incremented but the key contents are
updated. This lets the current lock holder update the key contents
without having to give up the lock and reacquire it.</p></li> <li><p><code>releaseSession</code><br>
This flag is used to turn the PUT into a lock release operation.
This is useful when paired with <code>acquireSession</code> as it allows
clients to yield a lock. This will leave the LockIndex unmodified
but will clear the associated Session of the key. The key must be
held by this session to be unlocked.</p></li></ul> <h2 id="transactions"><a href="#transactions" class="header-anchor">#</a> Transactions</h2> <p>When connected to Consul 0.7 and later, client allows to manage updates
or fetches of multiple keys inside a single, atomic transaction. KV is
the only available operation type, though other types of operations may
be added in future versions of Consul to be mixed with key/value
operations (see
<a href="https://www.consul.io/docs/agent/http/kv.html#txn" target="_blank" rel="noopener noreferrer">documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TxnRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setOperations</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">TxnKVOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;value1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">&quot;SET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TxnKVOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">&quot;key2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">&quot;SET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

consulClient<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;succeeded results: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>results<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;errors: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="delete-key-value-pair"><a href="#delete-key-value-pair" class="header-anchor">#</a> Delete key-value pair</h2> <p>At last, Consul client allows to delete key-value pair from store:</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">deleteValue</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>…​or all key-value pairs with corresponding key prefix</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">deleteValues</span><span class="token punctuation">(</span><span class="token string">&quot;prefix&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="services"><a href="#services" class="header-anchor">#</a> Services</h1> <p>One of the main goals of service discovery is to provide a catalog of
available services. To that end, the agent provides a simple service
definition format to declare the availability of a service and to
potentially associate it with a health check.</p> <h2 id="service-registering"><a href="#service-registering" class="header-anchor">#</a> Service registering</h2> <p>A service definition must include a <code>name</code> and may optionally provide an
<code>id</code>, <code>tags</code>, <code>address</code>, <code>port</code>, and <code>checks</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;serviceName&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;serviceId&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;tag1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tag2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setCheckOptions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CheckOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setTtl</span><span class="token punctuation">(</span><span class="token string">&quot;10s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;10.0.0.1&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">8048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p><code>name</code><br>
the name of service</p></li> <li><p><code>id</code><br>
the <code>id</code> is set to the <code>name</code> if not provided. It is required that
all services have a unique ID per node, so if names might conflict
then unique IDs should be provided.</p></li> <li><p><code>tags</code><br>
list of values that are opaque to Consul but can be used to
distinguish between primary or secondary nodes, different versions,
or any other service level labels.</p></li> <li><p><code>address</code><br>
used to specify a service-specific IP address. By default, the IP
address of the agent is used, and this does not need to be provided.</p></li> <li><p><code>port</code><br>
used as well to make a service-oriented architecture simpler to
configure; this way, the address and port of a service can be
discovered.</p></li> <li><p><code>checks</code><br>
associated health checks</p></li></ul> <p>These options used to register service in catalog:</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service successfully registered&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="service-discovery"><a href="#service-discovery" class="header-anchor">#</a> Service discovery</h2> <p>Consul client allows to obtain actual list of the nodes providing a
service</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">catalogServiceNodes</span><span class="token punctuation">(</span><span class="token string">&quot;serviceName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;found &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; services&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;consul state index: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">service</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service node: &quot;</span> <span class="token operator">+</span> service<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service address: &quot;</span> <span class="token operator">+</span> service<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service port: &quot;</span> <span class="token operator">+</span> service<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It is possible to obtain this list with the statuses of the associated
health checks. The result can be filtered by check status.</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">healthServiceNodes</span><span class="token punctuation">(</span><span class="token string">&quot;serviceName&quot;</span><span class="token punctuation">,</span> passingOnly<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;found &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; services&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;consul state index: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service node: &quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service address: &quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span>service<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service port: &quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span>service<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>There are additional parameters for services queries</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> queryOpts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;tag1&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setNear</span><span class="token punctuation">(</span><span class="token string">&quot;_agent&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setBlockingOptions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BlockingQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p><code>tag</code><br>
by default, all nodes matching the service are returned. The list
can be filtered by tag using the <code>tag</code> query parameter</p></li> <li><p><code>near</code><br>
adding the optional <code>near</code> parameter with a node name will sort the
node list in ascending order based on the estimated round trip time
from that node. Passing <code>near</code>=<code>_agent</code> will use the agent’s node
for the sort.</p></li> <li><p><code>blockingOptions</code><br>
the blocking qyery options</p></li></ul> <p>Then the request should look like</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">healthServiceNodesWithOptions</span><span class="token punctuation">(</span><span class="token string">&quot;serviceName&quot;</span><span class="token punctuation">,</span> passingOnly<span class="token punctuation">,</span> queryOpts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;found &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; services&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="deregister-service"><a href="#deregister-service" class="header-anchor">#</a> Deregister service</h2> <p>Service can be deregistered by its ID:</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">deregisterService</span><span class="token punctuation">(</span><span class="token string">&quot;serviceId&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Service successfully deregistered&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="health-checks"><a href="#health-checks" class="header-anchor">#</a> Health Checks</h1> <p>One of the primary roles of the agent is management of system-level and
application-level health checks. A health check is considered to be
application-level if it is associated with a service. If not associated
with a service, the check monitors the health of the entire node.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setTcp</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:4848&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token string">&quot;1s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The list of check options that supported by Consul client is:</p> <ul><li><p><code>id</code><br>
the check ID</p></li> <li><p><code>name</code><br>
check name</p></li> <li><p><code>script</code><br>
local path to checking script. Also you should set checking interval</p></li> <li><p><code>http</code><br>
HTTP address to check. Also you should set checking interval</p></li> <li><p><code>ttl</code><br>
Time to Live of check</p></li> <li><p><code>tcp</code><br>
TCP address to check. Also you should set checking interval</p></li> <li><p><code>interval</code><br>
checking interval in Go’s time format which is sequence of decimal
numbers, each with optional fraction and a unit suffix, such as
&quot;300ms&quot;, &quot;-1.5h&quot; or &quot;2h45m&quot;. Valid time units are &quot;ns&quot;, &quot;us&quot; (or
&quot;µs&quot;), &quot;ms&quot;, &quot;s&quot;, &quot;m&quot;, &quot;h&quot;</p></li> <li><p><code>notes</code><br>
the check notes</p></li> <li><p><code>serviceId</code><br>
the service ID to associate the registered check with an existing
service provided by the agent.</p></li> <li><p><code>deregisterAfter</code><br>
deregister timeout. This is optional field, which is a timeout in
the same time format as Interval and TTL. If a check is associated
with a service and has the critical state for more than this
configured value, then its associated service (and all of its
associated checks) will automatically be deregistered. The minimum
timeout is 1 minute, and the process that reaps critical services
runs every 30 seconds, so it may take slightly longer than the
configured timeout to trigger the deregistration. This should
generally be configured with a timeout that’s much, much longer than
any expected recoverable outage for the given service.</p></li> <li><p><code>status</code><br>
the check status to specify the initial state of the health check</p></li></ul> <p>The <code>Name</code> field is mandatory, as is one of <code>Script</code>, <code>HTTP</code>, <code>TCP</code> or
<code>TTL</code>. <code>Script</code>, <code>TCP</code> and <code>HTTP</code> also require that <code>Interval</code> be set.
If an <code>ID</code> is not provided, it is set to <code>Name</code>. You cannot have
duplicate ID entries per agent, so it may be necessary to provide an ID.</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">registerCheck</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;check successfully registered&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="events"><a href="#events" class="header-anchor">#</a> Events</h1> <p>The Consul provides a mechanism to fire a custom user event to an entire
datacenter. These events are opaque to Consul, but they can be used to
build scripting infrastructure to do automated deploys, restart
services, or perform any other orchestration action.</p> <p>To send user event only its name is required</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">fireEvent</span><span class="token punctuation">(</span><span class="token string">&quot;eventName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Event sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;id: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Also additional options can be specified.</p> <ul><li><p><code>node</code><br>
regular expression to filter recipients by node name</p></li> <li><p><code>service</code><br>
regular expression to filter recipients by service</p></li> <li><p><code>tag</code><br>
regular expression to filter recipients by tag</p></li> <li><p><code>payload</code><br>
an optional body of the event. The body contents are opaque to
Consul and become the &quot;payload&quot; of the event</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;tag&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setPayload</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

consulClient<span class="token punctuation">.</span><span class="token function">fireEventWithOptions</span><span class="token punctuation">(</span><span class="token string">&quot;eventName&quot;</span><span class="token punctuation">,</span> opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Event sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;id: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The Consul Client supports queries for obtain the most recent events
known by the agent. Events are broadcast using the gossip protocol, so
they have no global ordering nor do they make a promise of delivery.
Agents only buffer the most recent entries. The current buffer size is
256, but this value could change in the future.</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">listEvents</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Consul index: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Event id: &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Event name: &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Event payload: &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The Consul Index can be used to prepare blocking requests:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventListOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;eventName&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setBlockingOptions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BlockingQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

consulClient<span class="token punctuation">.</span><span class="token function">listEventsWithOptions</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Consul index: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Event id: &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="sessions"><a href="#sessions" class="header-anchor">#</a> Sessions</h1> <p>Consul provides a session mechanism which can be used to build
distributed locks. Sessions act as a binding layer between nodes, health
checks, and key/value data. When a session is constructed, a node name,
a list of health checks, a behavior, a TTL, and a lock-delay may be
provided.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setNode</span><span class="token punctuation">(</span><span class="token string">&quot;nodeId&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setBehavior</span><span class="token punctuation">(</span><span class="token string">&quot;RELEASE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p><code>lockDelay</code><br>
can be specified as a duration string using an 's' suffix for
seconds. The default is '15s'.</p></li> <li><p><code>name</code><br>
can be used to provide a human-readable name for the Session.</p></li> <li><p><code>node</code><br>
must refer to a node that is already registered, if specified. By
default, the agent’s own node name is used.</p></li> <li><p><code>checks</code><br>
is used to provide a list of associated health checks. It is highly
recommended that, if you override this list, you include the default
<code>serfHealth</code>.</p></li> <li><p><code>behavior</code><br>
can be set to either <code>release</code> or <code>delete</code>. This controls the
behavior when a session is invalidated. By default, this is
<code>release</code>, causing any locks that are held to be released. Changing
this to <code>delete</code> causes any locks that are held to be deleted.
<code>delete</code> is useful for creating ephemeral key/value entries.</p></li> <li><p><code>ttl</code><br>
is a duration string, and like <code>LockDelay</code> it can use s as a suffix
for seconds. If specified, it must be between 10s and 86400s
currently. When provided, the session is invalidated if it is not
renewed before the TTL expires.</p></li></ul> <p>For full info see <a href="https://www.consul.io/docs/internals/sessions.html" target="_blank" rel="noopener noreferrer">Consul Sessions
internals<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>The newly constructed session is provided with a named ID that can be
used to identify it. This ID can be used with the KV store to acquire
locks: advisory mechanisms for mutual exclusion.</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">createSessionWithOptions</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Session successfully created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;id: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>And also to destroy it</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">destroySession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Session successfully destroyed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Lists sessions belonging to a node</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">listNodeSessions</span><span class="token punctuation">(</span><span class="token string">&quot;nodeId&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">session</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Session id: &quot;</span> <span class="token operator">+</span> session<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Session node: &quot;</span> <span class="token operator">+</span> session<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Session create index: &quot;</span> <span class="token operator">+</span> session<span class="token punctuation">.</span>createIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>All of the read session endpoints support blocking queries and all
consistency modes.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> blockingOpts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockingQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

consulClient<span class="token punctuation">.</span><span class="token function">listSessionsWithOptions</span><span class="token punctuation">(</span>blockingOpts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Found &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; sessions&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="nodes-in-datacenter"><a href="#nodes-in-datacenter" class="header-anchor">#</a> Nodes in datacenter</h1> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">catalogNodes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;found &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; nodes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;consul state index &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This endpoint supports blocking queries and sorting by distance from
specified node</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setNear</span><span class="token punctuation">(</span><span class="token string">&quot;_agent&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setBlockingOptions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BlockingQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

consulClient<span class="token punctuation">.</span><span class="token function">catalogNodesWithOptions</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;found &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; nodes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="prepared-queries"><a href="#prepared-queries" class="header-anchor">#</a> Prepared Queries</h1> <p>This endpoint creates, updates, destroys, and executes prepared queries.
Prepared queries allow you to register a complex service query and then
execute it later via its ID or name to get a set of healthy nodes that
provide a given service. This is particularly useful in combination with
Consul’s DNS Interface as it allows for much richer queries than would
be possible given the limited entry points exposed by DNS.</p> <p>There are many parameters to creating a prepared query. For full details
please <a href="https://www.consul.io/api/query.html" target="_blank" rel="noopener noreferrer">see docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li><p><code>dc</code><br>
Specifies the datacenter to query. This will default to the
datacenter of the agent being queried. This is specified as part of
the URL as a query parameter.</p></li> <li><p><code>name</code><br>
Specifies an optional friendly name that can be used to execute a
query instead of using its ID.</p></li> <li><p><code>session</code><br>
Specifies the ID of an existing session. This provides a way to
automatically remove a prepared query when the given session is
invalidated. If not given the prepared query must be manually
removed when no longer needed.</p></li> <li><p><code>token</code><br>
Specifies the ACL token to use each time the query is executed. This
allows queries to be executed by clients with lesser or even no ACL
Token, so this should be used with care. The token itself can only
be seen by clients with a management token. If the Token field is
left blank or omitted, the client’s ACL Token will be used to
determine if they have access to the service being queried. If the
client does not supply an ACL Token, the anonymous token will be
used.</p></li> <li><p><code>service</code><br>
Specifies the name of the service to query. This is required field.</p></li> <li><p><code>failover</code><br>
contains two fields, both of which are optional, and determine what
happens if no healthy nodes are available in the local datacenter
when the query is executed. It allows the use of nodes in other
datacenters with very little configuration.</p></li> <li><p><code>nearestN</code><br>
Specifies that the query will be forwarded to up to NearestN other
datacenters based on their estimated network round trip time using
Network Coordinates from the WAN gossip pool. The median round trip
time from the server handling the query to the servers in the remote
datacenter is used to determine the priority.</p></li> <li><p><code>datacenters</code><br>
Specifies a fixed list of remote datacenters to forward the query to
if there are no healthy nodes in the local datacenter. Datacenters
are queried in the order given in the list. If this option is
combined with NearestN, then the NearestN queries will be performed
first, followed by the list given by Datacenters. A given datacenter
will only be queried one time during a failover, even if it is
selected by both NearestN and is listed in Datacenters.</p></li> <li><p><code>onlyPassing</code><br>
Specifies the behavior of the query’s health check filtering. If
this is set to false, the results will include nodes with checks in
the passing as well as the warning states. If this is set to true,
only nodes with checks in the passing state will be returned.</p></li> <li><p><code>tags</code><br>
Specifies a list of service tags to filter the query results. For a
service to pass the tag filter it must have all of the required
tags, and none of the excluded tags (prefixed with !).</p></li> <li><p><code>nodeMeta</code><br>
Specifies a list of user-defined key/value pairs that will be used
for filtering the query results to nodes with the given metadata
values present.</p></li> <li><p><code>dnsTtl</code><br>
Specifies the TTL duration when query results are served over DNS.
If this is specified, it will take precedence over any Consul
agent-specific configuration.</p></li> <li><p><code>templateType</code><br>
is the query type, which must be <code>name_prefix_match</code>. This means
that the template will apply to any query lookup with a name whose
prefix matches the Name field of the template. In this example, any
query for geo-db will match this query. Query templates are resolved
using a longest prefix match, so it’s possible to have high-level
templates that are overridden for specific services. Static queries
are always resolved first, so they can also override templates.</p></li> <li><p><code>templateRegexp</code><br>
is an optional regular expression which is used to extract fields
from the entire name, once this template is selected. In this
example, the regular expression takes the first item after the &quot;-&quot;
as the database name and everything else after as a tag. See the RE2
reference for syntax of this regular expression.</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreparedQueryDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Query name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token string">&quot;service-${match(1)}-${match(2)}&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setDcs</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;dc1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dc42&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setTemplateType</span><span class="token punctuation">(</span><span class="token string">&quot;name_prefix_match&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setTemplateRegexp</span><span class="token punctuation">(</span><span class="token string">&quot;^find_(.+?)_(.+?)$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If the query is successfully created, its ID will be provided</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">createPreparedQuery</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> queryId <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Query created: &quot;</span> <span class="token operator">+</span> queryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The prepared query can be executed by its id</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">executePreparedQuery</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Found &quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; nodes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>or by query string that must match template regexp</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">executePreparedQuery</span><span class="token punctuation">(</span><span class="token string">&quot;find_1_2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// matches template regexp &quot;^find_(.+?)_(.+?)$&quot;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Found &quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; nodes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally, <code>ConsulClient</code> allows you to modify, get or delete prepared
queries</p> <div class="language-js extra-class"><pre class="language-js"><code>consulClient<span class="token punctuation">.</span><span class="token function">deletePreparedQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Query deleted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="watches"><a href="#watches" class="header-anchor">#</a> Watches</h1> <p>Watches are a way of specifying a view of data (e.g. list of nodes, KV
pairs, health checks) which is monitored for updates. When an update is
detected, an <code>Handler</code> with <code>WatchResult</code> is invoked. As an example, you
could watch the status of health checks and notify when a check is
critical.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@vertx/consul&quot;</span>
Watch<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token string">&quot;foo/bar&quot;</span><span class="token punctuation">,</span> vertx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;value: &quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">nextResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/reactiverse/es4x/edit/develop/docs/manual/@vertx/consul-client/index.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/30/2020, 11:09:36 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/es4x/assets/js/app.837a6700.js" defer></script><script src="/es4x/assets/js/2.96613d0f.js" defer></script><script src="/es4x/assets/js/64.a9a5d5d7.js" defer></script>
  </body>
</html>
